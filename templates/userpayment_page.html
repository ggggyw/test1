<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>支付</title>
    {% load static %}
    <link rel="stylesheet" href="{% static '首页_files/login.css' %}">
    <link rel="stylesheet" href="{% static '首页_files/index.css' %}">
    <link rel="stylesheet" href="{% static '首页_files/detail.css' %}">
</head>
<body>
<div class="head">
    <div class="head-in">
        <ul class="options">
            <li class="sub"><a href="/user/userorder">我的订单</a></li>
            <li class="sub"><a href="/user/userserve">客户服务</a></li>
            <li class="sub"><a href="/user/usercart">我的购物车</a></li>
        </ul>
        <div class="register"><a href="{% url 'userprofile' %}">查看个人信息</a></div>
        <div class="register"><a href="{% url 'logout' %}">退出登录</a></div>
        <div class="hello">欢迎您！欢迎来到数码产品网上交易平台</div>
    </div>
</div>
{% csrf_token %}

<div class="payment-container">
    <h2>支付页面</h2>
    <form id='payment-form' method='post'>
        <div class='payment-method'>
            <h3>支付方式：</h3>
            <select name='payment-method' id='payment-method' required>
                <option value="">请选择支付方式</option>
                <option value="alipay">支付宝</option>
                <option value="wechat">微信</option>
                <option value="bank">银行</option>
            </select>
        </div>
        <div class='payment-info'>
            <h3>支付信息：</h3>
            <label for='name'>姓名：</label>
            <input type='text' id='name' name='name' required><br/>
            <label for='card_number'>卡号/账户：</label>
            <input type='text' id='card_number' name='card_number' required><br/>
            <label for='exp_date'>到期日期（仅限银行卡）：</label>
            <input type='text' id='exp_date' name='exp_date' ><br/>
            <label for='cvc'>CVC/安全码（仅限银行卡）：</label>
            <input type='text' id='cvc' name='cvc'><br/>
        </div>
        <div class='payment-amount'>
            <h3>支付金额：</h3>
            <span id='total-price'>¥0.00</span>
        </div>
        <!-- 二维码容器 -->
        <div id="qrcode"></div>
        <div class='payment-confirmation'>
            <input type='submit' id='confirm-btn' value='确认支付'>
            <button id='cancel-btn'>放弃支付</button>
        </div>
    </form>
</div>

<script src="{% static 'qrcodejs-master/qrcode.js' %}"></script>
<script>
// 填充支付金额
document.getElementById('total-price').textContent = '¥' + localStorage.getItem('totalPrice');

// 当点击确认支付按钮时，将表单数据发送到后端进行处理
document.getElementById('confirm-btn').addEventListener('click', function(e) {
    e.preventDefault(); // 防止表单自动提交

    var paymentMethod = document.getElementById('payment-method').value;
    var name = document.getElementById('name').value;
    var cardNumber = document.getElementById('card_number').value;
    var expDate = document.getElementById('exp_date').value;
    var cvc = document.getElementById('cvc').value;
    var totalAmount = localStorage.getItem('totalPrice');

    var data = {
        payment_method: paymentMethod,
        name: name,
        card_number: cardNumber,
        exp_date: expDate,
        cvc: cvc,
        total_amount: totalAmount,
        order_id:localStorage.getItem('order_id')
    };

    var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // 发送请求到后端处理支付
    fetch('/process_payment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        // 根据服务器返回的结果显示相应的消息
        if (data.success) {
            alert("支付成功！")
            window.location.href = 'userorder';
        } else {
            alert(data.message)
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("请求失败，请检查网络连接或稍后重试");
    });
});

// 当点击 ‘放弃支付’ 按钮时，重定向回订单页面
document.getElementById('cancel-btn').addEventListener('click', function(e) {
    e.preventDefault();  // 防止默认的表单提交
    window.location.href = 'userorder';
});

function generateQRCode(paymentInfo) {
    // 首先清除之前可能存在的二维码
    var qrcodeContainer = document.getElementById('qrcode');
    qrcodeContainer.innerHTML = "";

    // 使用 qrcode.js 创建二维码
    var qrCode = new QRCode(qrcodeContainer, {
        text: paymentInfo,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });
}

// 当改变支付方式时，生成相应的二维码
document.getElementById('payment-method').addEventListener('change', function(e) {
    var selectedMethod = e.target.value;
    if (selectedMethod === "") {
        document.getElementById('qrcode').innerHTML = "";
        return;
    }

    // 假设生成二维码的数据基于选择的支付方式
    var paymentDataForQR = "https://example.com/pay?method=" + selectedMethod;

    // 调用 generateQRCode 函数生成二维码
    generateQRCode(paymentDataForQR);
});

</script>
</body>
</html>