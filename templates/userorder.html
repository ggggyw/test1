<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    {% load static %}
    <title>订单</title>
    <link rel="stylesheet" href="{% static '首页_files/index.css' %}">
    <script src="{% static '首页_files/jquery.min.js.下载' %}"></script>

    <style>
        {% load static %}
      body {
        font-family: Arial, sans-serif;
        background: #f3f3f3;
        margin: 0;
        padding: 0;
        position: relative;
        min-height: 100vh;
    }
    .order-options-container {
        width: 90%;
        margin: 30px auto;
        background: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .order-details-container {
        width: 98%;
        margin: 10px auto;
        background: #e3e2e2;
        padding: 1px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .order-options {
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        width: 400px;
    }
    .order-details {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
    }
    .order-details > div{
        flex: 1;
        text-align: center;
        padding: 1px 0;
    }
    .order-options > li {
        flex: 1;
        text-align: center;
        padding: 5px 0px;
        margin-right: 0px;

    }
    .order-options > li a:active {
        color: #ff464e; /* 设置第一个选项被点击后的字体颜色为红色 */
    }

    .order-options > li a:hover {
        color: #ff464e; /* 设置第一个选项被鼠标悬停时的字体颜色为红色 */
    }

.oorder-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
    width: 100%;
    /* 设置弹性容器的内边距为0，确保没有额外的空间 */
    gap: 0;
}

.oorder-details-block {
    flex: 1;
    margin-right: 10px;
    /* 调整宽度 */
    width: 19%; /* 使用19%确保五个子元素紧挨着 */
}

.total-amount,
.status {
    /* 调整宽度 */
    text-align: center;
    width: 19%; /* 使用19%确保五个子元素紧挨着 */
}
.user_id{
    /* 调整宽度 */
    text-align: center;
    width: 19%; /* 使用19%确保五个子元素紧挨着 */
}
.caozuo{
    /* 调整宽度 */
    text-align: center;
    width: 19%; /* 使用19%确保五个子元素紧挨着 */
}
.oorder-container .oorder-product-details {
    display: flex;
    {#flex-direction: column;#}
}

.oorder-container .oorder-product img {
    width: 90px;
    height: 90px;
    margin-right: 10px;
}

.oorder-container .oorder-product p {
    margin: 0;
}

.oorder-container p {
    margin: 5px 0;
}

.oorder-details {
    display: flex;
    flex-direction: column;
    width: 180px;
}

.oorder-details .oorder-product {
    display: flex;
    align-items: center;
}


{#按钮----------------------------------------------------------------------------------------------------#}
.box {
  width: 140px;
  height: auto;
  float: left;
  transition: .5s linear;
  position: relative;
  display: block;
  overflow: hidden;
  padding: 15px;
  text-align: center;
  margin: 0 5px;
  background: transparent;
  text-transform: uppercase;
  font-weight: 900;
}

.box:before {
  position: absolute;
  content: '';
  left: 0;
  bottom: 0;
  height: 4px;
  width: 100%;
  border-bottom: 4px solid transparent;
  border-left: 4px solid transparent;
  box-sizing: border-box;
  transform: translateX(100%);
}

.box:after {
  position: absolute;
  content: '';
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  border-top: 4px solid transparent;
  border-right: 4px solid transparent;
  box-sizing: border-box;
  transform: translateX(-100%);
}

.box:hover {
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}

.box:hover:before {
  border-color: #262626;
  height: 100%;
  transform: translateX(0);
  transition: .3s transform linear, .3s height linear .3s;
}

.box:hover:after {
  border-color: #262626;
  height: 100%;
  transform: translateX(0);
  transition: .3s transform linear, .3s height linear .5s;
}

button {
  color: black;
  text-decoration: none;
  cursor: pointer;
  outline: none;
  border: none;
  background: transparent;
}
.oorder-container, .oorder-product, .oorder-product-details, .oorder-details, .oorder-details-block, .total-amount, .user_id, .caozuo ,.order-options,.order-details{
    opacity: 0;
    animation: fadeInUp 0.5s ease forwards;
}

@keyframes fadeInUp {
    0% {
        opacity: 0;
        transform: translateY(50px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}
{#按钮--------------------------------------------------------------------------------------------------#}
</style>

</head>
<body>

<div class="head">
    <div class="head-in">
        <ul class="options">
            <li class="sub"><a href="/user/userorder">我的订单</a></li>
            <li class="sub"><a href="/user/userserve">客户服务</a></li>
            <li class="sub"><a href="/user/usercart">我的购物车</a></li>
        </ul>
        <div class="register"><a href="{% url 'userprofile' %}">查看个人信息</a></div>
        <div class="register"><a href="{% url 'logout' %}">退出登录</a></div>
        <div class="hello">欢迎您！欢迎来到数码产品网上交易平台</div>
    </div>
</div>
<div class="search">
    <ul class="items">
        <li class="item">
            <a href="http://127.0.0.1:8000/userpage">
                <img src="{% static '首页_files/1_09.png' %}">
                <p>10:00开抢</p>
            </a>
        </li>
        <li class="item">
            <a href="http://127.0.0.1:8000/userpage">
                <img src="{% static '首页_files/1_11.png' %}">
                <p>买手砍价</p>
            </a>
        </li>
        <li class="item">
            <a href="http://127.0.0.1:8000/userpage">
                <img src="{% static '首页_files/1_13.png' %}">
                <p>验货质检</p>
            </a>
        </li>
    </ul>
    <form action="{% url 'search_products' %}" method="get" id="search-form" class="input">
    <input type="text" name="q" value="请输入想找的宝贝" style="color: #aaa;" onfocus="if (this.value == '请输入想找的宝贝') {this.value = ''; this.style.color = '#000';}" onblur="if (this.value == '') {this.value = '请输入想找的宝贝'; this.style.color = '#aaa';}">
    <img src="{% static '首页_files/1_06.png' %}" onclick="document.getElementById('search-form').submit();" style="cursor: pointer;">
</form>
</div>
<div class="order-options-container">
    <ul class="order-options">
        <li><a href="/user/userorder" data-status="all" class="title">全部订单</a></li>
        <li><a href="/user/userorder?status=pending" data-status="pending">待付款</a></li>
        <li><a href="/user/userorder?status=shipped" data-status="shipped">待收货/使用</a></li>
        <li><a href="/user/userorder?status=review" data-status="review">待评价</a></li>
        <li><a href="/user/userorder?status=recycle" data-status="recycle">订单回收站</a></li>
    </ul>

    <div id="order-details-container" class="order-details-container">
    <div class="order-details">
        <div class="detail">订单详情</div>
        <div class="recipient">收货人</div>
        <div class="amount">金额</div>
        <div class="status">全部状态</div>
        <div class="actions">操作</div>
    </div>
    </div>

</div>




<script>
    $(document).ready(function() {
    // 获取当前 URL 中的 status 参数
    var urlParams = new URLSearchParams(window.location.search);
    var status = urlParams.get('status');

    // 如果 status 参数为 'shipped'，延迟 1 秒后触发对应按钮的点击事件
    if (status === 'shipped') {
        setTimeout(function() {
            $('a[data-status="shipped"]').trigger('click');
        }, 300);
    }
    else if (status === 'pending')
    {
        setTimeout(function() {
            $('a[data-status="pending"]').trigger('click');
        }, 300);
    }
    $('.order-options a').click(function(e) {
        e.preventDefault();
        var clickedStatus = $(this).attr('data-status');
        getOrdersByStatus(clickedStatus);
    });
});


$(document).ready(function() {
    $.ajax({
        url: '/user_orders/',  // 后端 API 地址
        type: 'GET',
success: function(response) {
    var ordersData = response.orders;
    var ordersContent = '';
    for (var i = 0; i < ordersData.length; i++) {
        var order = ordersData[i];
        var orderDetailsContent = '';
        for (var j = 0; j < order.order_details.length; j++) {
            var orderDetail = order.order_details[j];
            orderDetailsContent += '<div class="oorder-product">' +
                '<div class="oorder-product-details">' +
                '<img src="{% static '商品图片/' %}' + orderDetail.product_image_url + '">' +
                '<div>'+
                '<p>' + orderDetail.product_name + '</p>' +
                '<p>数量：' + orderDetail.quantity + '</p>' +
                '<p>单价：' + orderDetail.price + '</p>' +
                '<input type="hidden" name="product_ids[]" value="' + orderDetail.product_id + '">' +
                '</div>'+
                '</div></div>';
        }
        ordersContent += '<div class="oorder-container">' +
            '<div >' +
            {#'<p>订单号：' + order.order_id + '</p>' +#}
            '<input type="hidden" name="orders[]" value="' + order.order_id + '">' +
            '<div class="oorder-details">' + orderDetailsContent + '</div>' +
            '</div>' +
             '<div class="user_id">' +
            '<p>' + order.user_id + '</p>' +
            '</div>' +
            '<div class="total-amount">' +
            '<p>' + order.total_amount +'元'+ '</p>' +
            '</div>' +
            '<div class="status">' +
            '<p>' + order.status + '</p>' +
            '</div>' +
            '<div class="caozuo">' +
                '<button>' +'<span class="box">'+ "再次购买" + '</span>'+'</button>' +
                 '<button>' +'<span class="box">'+ "删除" + '</span>'+'</button>' +
            '</div>' +
            '</div>';
    }
    $('#order-details-container').append(ordersContent);
    showOrdersWithAnimation();
},
        error: function(xhr, status, error) {
            console.error(error);
            $('#order-details-container').html('<p>获取订单失败</p>');
        }
    });

 $(document).on('click', '.caozuo button:first-child', function() {
        var orderContainer = $(this).closest('.oorder-container');
        var orderDetails = orderContainer.find('.oorder-product');

        var products = [];
        var order = {};
        // 从订单详情中提取商品信息
        orderDetails.each(function() {
            var product = {};
            product.product_id = $(this).find('input[name="product_ids[]"]').val();
            product.product_name = $(this).find('p:nth-child(1)').text();
            product.quantity = $(this).find('p:nth-child(2)').text().split('：')[1];
            product.price = $(this).find('p:nth-child(3)').text().split('：')[1];
            products.push(product);
        });
        order.user_id = orderContainer.find('.user_id p').text();
        var totalPriceText = orderContainer.find('.total-amount p').text();
        order.total_price = parseFloat(totalPriceText.substring(0, totalPriceText.length - 1));
        order.status = orderContainer.find('.status p').text();

        // 发送再次购买请求到后端
        $.ajax({
            url: '/again_buy/',
            type: 'POST',
            contentType: 'application/json', // Specify JSON content type
            data: JSON.stringify({
                products: products,
                order: order
            }),
            success: function(response) {
                // Handle success response
                alert('再次购买成功');
                location.reload();
            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error(error);
                alert('再次购买失败，请重试');
            }
        });

    });

});
function showOrdersWithAnimation() {
        $('.oorder-container').each(function(index) {
            $(this).css('opacity', 0).delay(index * 200).animate({
                opacity: 1,
                top: '0'
            }, 500);
        });
    }
function getOrdersByStatus(status) {
    $.ajax({
        url: '/user_orders/',
        type: 'GET',
        data: {
            status: status
        },
        success: function(response) {
            // 清除旧的订单内容
            $('#order-details-container .oorder-container').remove();
            // 插入新的订单内容
            var ordersData = response.orders;
            var ordersContent = '';
            for (var i = 0; i < ordersData.length; i++) {
                var order = ordersData[i];
                var orderDetailsContent = '';
                for (var j = 0; j < order.order_details.length; j++) {
                    var orderDetail = order.order_details[j];
                    orderDetailsContent += '<div class="oorder-product">' +
                        '<div class="oorder-product-details">' +
                        '<img src="{% static '商品图片/' %}' + orderDetail.product_image_url + '">' +
                        '<div>'+
                        '<p>' + orderDetail.product_name + '</p>' +
                        '<p>数量：' + orderDetail.quantity + '</p>' +
                        '<p>单价：' + orderDetail.price + '</p>' +
                        '<input type="hidden" name="product_ids[]" value="' + orderDetail.product_id + '">' +
                        '</div>'+
                        '</div></div>';
                }
                ordersContent += '<div class="oorder-container">' +
                    '<div >' +
                    '<input type="hidden" name="orders[]" value="' + order.order_id + '">' +
                    '<div class="oorder-details">' + orderDetailsContent + '</div>' +
                    '</div>' +
                    '<div class="user_id">' +
                    '<p>' + order.user_id + '</p>' +
                    '</div>' +
                    '<div class="total-amount">' +
                    '<p>' + order.total_amount +'元'+ '</p>' +
                    '</div>' +
                    '<div class="status">' +
                    '<p>' + order.status + '</p>' +
                    '</div>' +
                    '<div class="caozuo">' +
                    '<button>' +'<span class="box">'+ "再次购买" + '</span>'+'</button>' +
                     '<button>' +'<span class="box">'+ "删除" + '</span>'+'</button>' +
                    '</div>' +
                    '</div>';
            }
            $('#order-details-container').append(ordersContent);

                // 依次显示订单容器
                showOrdersWithAnimation();
            },
            error: function(xhr, status, error) {
                console.error(error);
                $('#order-details-container').html('<p>获取订单失败</p>');
            }
        });
    }


$(document).on('click', '.caozuo button:last-child', function() {
    var orderContainerr = $(this).closest('.oorder-container');
    var orderId = $(orderContainerr).find('input[name="orders[]"]').val();
    // 发送删除订单请求到后端
    $.ajax({
        url: '/delete_order/',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ order_id: orderId }),
        success: function(response) {

            alert('订单删除成功');
            orderContainerr.remove();
        },
        error: function(xhr, status, error) {
            console.error(error);
            alert('订单删除失败，请重试');
        }
    });
});
        document.addEventListener('DOMContentLoaded', function() {
    var elements = document.querySelectorAll('.oorder-container, .oorder-product, .oorder-product-details, .oorder-details, .oorder-details-block, .total-amount, .status, .user_id, .order-options,.order-details');
    var delay = 0.1;

    elements.forEach(function(element) {
        element.style.animationDelay = delay + 's';
        delay += 0.1;
    });
});

</script>

</body>
</html>
