<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    {% load static %}
    <title>shop_order</title>
    <link rel="stylesheet" href="{% static '商家_files/head.css' %}">
    <script src="{% static '首页_files/jquery.min.js.下载' %}"></script>
    <script src="{% static '首页_files/carts.js.下载' %}"></script>

    <style>
        .classes {
            background: #f4f4f4;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
        }


        .classes-items {
            text-align: center;
        }

        .items {
            text-align: center;
        }

        .order-detail-toggle {
            cursor: pointer;
            background-color: #f9f9f9;
            padding: 5px;
            text-align: center;
            border: 1px solid #d3d3d3;
        }

        .order-details {
            display: none;
            margin-top: 10px;
        }

        .rfm{
            display: none;
            margin-top:10px;
        }

        /* 将表格居中且宽度最大化，每列有一定的间距 */
        table {
            margin: 0 auto;
            width: 90%;
            border-collapse: separate;
            border-spacing: 0 15px; /* 控制列之间的间距 */
        }

        /* 调整表格标题和内部文本的样式 */
        th, td {
            text-align: center;
            padding: 10px 20px; /* 增加内填充以便有更多空间 */
        }

        /* 为表格标题设置一个背景颜色，字体颜色和字体大小 */
        thead th {
            background-color: #4CAF50; /* 示例背景颜色，可根据喜好修改 */
            color: white; /* 示例字体颜色，可根据喜好修改 */
            font-size: 1.1em;
        }

        /* 为表格每个单元格设置一个背景颜色 */
        tbody td {
            background-color: #f2f2f2; /* 示例背景颜色，可根据喜好修改 */
            border-bottom: 1px solid #ddd; /* 为了清晰分隔各行 */
        }

        /* 为操作按钮增加一些样式来使其更加醒目 */
        .order-detail-toggle {
            border: none; /* 移除边框 */
            color: white; /* 设置字体颜色 */
            padding: 5px 10px; /* 设置内填充 */
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            transition-duration: 0.4s;
            cursor: pointer;
            background-color: #008CBA; /* 背景颜色 */
        }

        /* 当鼠标悬停在操作按钮上时，改变其样式以提供反馈 */
        .order-detail-toggle:hover {
            background-color: #333;
            color: white;
        }

        /* 为发货按钮增加一些样式来使其更加醒目 */
        .order-ship-toggle {
            border: none; /* 移除边框 */
            color: white; /* 设置字体颜色 */
            padding: 5px 10px; /* 设置内填充 */
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            transition-duration: 0.4s;
            cursor: pointer;
            background-color: #29ce01; /* 背景颜色 */
        }

        /* 当鼠标悬停在发货按钮上时，改变其样式以提供反馈 */
        .order-ship-toggle:hover {
            background-color: #333;
            color: white;
        }

        .Model {
            display: none; /* 默认不显示模态框 */
            position: fixed; /* 固定定位 */
            z-index: 1; /* z-index 确保模态框在其他内容上方 */
            left: 0;
            top: 0;
            width: 100%; /* 宽度为整个视窗的宽 */
            height: 100%; /* 高度为整个视窗的高 */
            overflow: auto; /* 如果内容过多，出现滚动条 */
            background-color: rgba(0, 0, 0, 0.4); /* 背景颜色带透明度 */
        }

        .Model-content {
            background-color: #fefefe; /* 模态框内容背景颜色 */
            margin: 5% auto; /* 上下外边距及自动居中 */
            padding: 20px; /* 内边距 */
            border: 1px solid #888; /* 边框 */
            width: 50%; /* 宽度 */
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2); /* 添加阴影效果 */
            position: relative; /* 相对定位 */
            overflow: hidden; /* 隐藏溢出的内容 */
            border-radius: 10px; /* 圆角边框 */
        }

        /* 模态框标题样式 */
        .Model-content h2 {
            background-color: #4CAF50; /* 标题背景颜色 */
            color: white; /* 标题文本颜色 */
            padding: 10px 20px; /* 标题内填充 */
            margin: -20px -20px 20px -20px; /* 标题外边距 */
            border-top-left-radius: 10px; /* 左上角圆角 */
            border-top-right-radius: 10px; /* 右上角圆角 */
            text-align: center; /* 文本居中 */
        }

        /* 模态框关闭按钮样式 */
        .close {
            position: absolute; /* 绝对定位 */
            top: 10px; /* 距离顶部 */
            right: 20px; /* 距离右侧 */
            color: #aaa; /* 颜色 */
            text-shadow: none; /* 禁用文本阴影 */
            font-weight: normal; /* 字重 */
        }

        /* 模态框中的段落样式 */
        .Model-content p {
            font-size: 16px; /* 字体大小 */
            line-height: 1.6; /* 行高 */
            margin-bottom: 15px; /* 段落之间的间距 */
            text-align: left; /* 文本左对齐 */
            border-bottom: 1px solid #eee; /* 可选：每个信息项之间的分割线 */
            padding-bottom: 10px; /* 可选：分割线上方的内边距 */
        }

        /* 最后一个段落的样式，没有底部边框 */
        .Model-content p:last-of-type {
            border-bottom: none; /* 去掉最后一个段落的分割线 */
            margin-bottom: 0; /* 调整最后一个段落的外边距 */
            padding-bottom: 0; /* 调整最后一个段落的内边距 */
        }

        /* 模态框中图片的样式 */
        .Model-content img {
            margin-top: 10px; /* 图片上方的外边距 */
            display: block; /* 使图片块状显示 */
            margin-left: auto; /* 左自动外边距 */
            margin-right: auto; /* 右自动外边距 */
            max-width: 100%; /* 最大宽度为容器宽度 */
            height: auto; /* 高度自动 */
        }

        .close {
            color: #0c0c0c; /* 关闭按钮颜色 */
            float: right; /* 右浮动 */
            font-size: 28px; /* 字号 */
            font-weight: bold; /* 字重 */
        }

        .close:hover,
        .close:focus {
            color: #e11111; /* 鼠标悬浮或聚焦时颜色改变 */
            text-decoration: none;
            cursor: pointer;
        }

        /* 点击时的高亮背景颜色 */
        .highlight {
            background-color: #ffff99; /* 浅黄色的背景 */
        }


        tbody tr.order-row:hover {
            font-size: 13px; /* 设定鼠标悬停时的字体大小 */
            cursor: pointer; /* 可选，显示鼠标悬停效果 */
            transition: font-size 0.8s ease; /* 平滑的字体大小变化 */
            color: #008CBA; /* 蓝色字体 */
        }

        /* “详情”行在悬停时的样式 */
        tbody tr.order-detail-row:hover {
            color: #008CBA;
            font-size: 13px; /* 设定鼠标悬停时的字体大小 */
            cursor: default;
            transition: background-color 0.3s ease;
        }

        /* 设置为链接的用户名字和商品名字的样式 */
        .dialogue-link {
            cursor: pointer;
            color: #008CBA; /* 蓝色字体 */
            text-decoration: underline; /* 文字下划线 */
            transition: font-size 0.5s ease; /* 平滑的字体大小变化 */
        }

        /* 鼠标悬停在用户名字和商品名字上时的样式 */
        .dialogue-link:hover {
            font-size: 20px; /* 鼠标悬停时字体大小变大 */
            color: #f51111; /* 鼠标悬停时字体颜色的变化 */
        }
    </style>
</head>
<body>

<div class="head">
    <div class="head-in">
        <div class="register"><a href="http://127.0.0.1:8000/shop/shoppage/shop_profile">查看个人信息</a></div>
        <div class="register"><a href="{% url 'logout' %}">退出登录</a></div>
    </div>
</div>
<div class="search">
    <div class="input">
        <input type="" name="" value="请输入想找的宝贝">
        <img src="{% static '首页_files/1_06.png' %}">
    </div>
</div>
<div class="classes">
    <ul class="classes-items">

        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/myproducts/?category_id=0">我的商品</a></li>
        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=0">管理商品</a></li>
        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/shop_order/">我的订单</a></li>
        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/rfm/">RFM分析</a></li>
    </ul>
</div>
<table>
    <thead>
    <tr>
        <th>订单ID</th>
        <th>用户</th>
        <th>状态</th>
        <th>支付时间</th>
        <th>订单时间</th>
        <th>总价</th>
        <th>操作</th> <!-- 添加一个标题用于展示操作按钮 -->
    </tr>
    </thead>
    <tbody>
    {% for order in orders %}
        <tr class="order-row" data-order-id="{{ order.o_id }}">
            <td>{{ order.o_id }}</td>
            <td>
            <span class="dialogue-link" onclick="showUserModel({{ order.user.u_id }})">
                {{ order.user.u_name }}
            </span>
            </td>
            <td id="status-{{ order.o_id }}">{{ order.status }}</td>
            <td>{{ order.paid_time }}</td>
            <td>{{ order.o_time }}</td>
            <td>{{ order.total_price }}</td>
            <td>
                <button class="order-detail-toggle"
                        onclick="toggleOrderDetails('details-{{ order.o_id }}'); event.stopPropagation();">
                    详情
                </button>
                <!-- 根据订单状态显示发货按钮 -->
                {% if order.status == '待发货' %}
                    <button class="order-ship-toggle" onclick="shipOrder({{ order.o_id }})">
                        发货
                    </button>
                {% endif %}
            </td>
        </tr>
        <tr id="details-{{ order.o_id }}" class="order-details">
            <td colspan="7">
                <table>
                    <thead>
                    <tr>
                        <th>订单详情ID</th>
                        <th>商品</th>
                        <th>商店</th>
                        <th>数量</th>
                        <th>当前单价</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for detail in order.orderdetails_set.all %}
                        <tr class="order-detail-row" data-order-id="{{ order.o_id }}">
                            <td>{{ detail.order_detail_id }}</td>
                            <td>
                                <span class="dialogue-link"
                                      onclick="showProductModel({{ detail.product.product.p_id }})">
                                           {{ detail.product.product.p_name }}
                                </span>
                            </td>
                            <td>{{ detail.shop.s_name }}</td>
                            <td>{{ detail.quantity }}</td>
                            <td>{{ detail.current_single_price }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<!-- 用户信息模态框 -->
<div id="userModel" class="Model">
    <div class="Model-content">
        <span class="close" onclick="closeModel('userModel')">&times;</span>
        <h2>用户信息</h2>
        <!-- 用户信息显示位置 -->
        <div id="userModelInfo">
            <p>用户名: <span id="userModel_u_name"></span></p>
            <p>性别: <span id="userModel_u_sex"></span></p>
            <p>手机号: <span id="userModel_u_phone"></span></p>
            <p>邮箱: <span id="userModel_u_email"></span></p>
            <p>地址: <span id="userModel_u_address"></span></p>
        </div>
    </div>
</div>

<!-- 商品信息模态框 -->
<div id="productModel" class="Model">
    <div class="Model-content">
        <span class="close" onclick="closeModel('productModel')">&times;</span>
        <h2>商品信息</h2>
        <!-- 商品信息显示位置 -->
        <div id="productInfo">
            <p>商品名称: <span id="productModel_p_name"></span></p>
            <p>商品类型: <span id="productModel_p_type"></span></p>
            <p>品牌: <span id="productModel_brand"></span></p>
            <p>当前价格: <span id="productModel_current_price"></span></p>
            <p>商品描述: <span id="productModel_product_desc"></span></p>
            <p>商品状态: <span id="productModel_product_status"></span></p>
            <p>库存数量: <span id="productModel_stock_quantity"></span></p>
            <p>原始价格: <span id="productModel_original_price"></span></p>
            <p>商品折扣: <span id="productModel_discount"></span></p>
            <p>商品图片:</p>
            <img id="productModel_product_image" src="" alt="" width="200" height="200">
        </div>
    </div>
</div>


<script>
    function toggleOrderDetails(detailId) {
        var details = document.getElementById(detailId);
        if (details.style.display === 'none' || details.style.display === '') {
            details.style.display = 'table-row'; // 显示订单详情
        } else {
            details.style.display = 'none'; // 隐藏订单详情
        }
    }

    // 关闭模态框的函数
    function closeModel(ModelId) {
        // 隐藏模态框
        document.getElementById(ModelId).style.display = 'none';
    }

    // 点击窗口外区域关闭任何打开的模态框
    window.onclick = function (event) {
        if (event.target.className === 'Model') {
            event.target.style.display = 'none';
        }
    }

    // 在用户点击用户名时调用的函数
    function showUserModel(userId) {
        // 获取用户名字的元素并添加高亮类
        var userNameElem = document.querySelector('td[onclick="showUserModel(' + userId + ')"]');
        if (userNameElem) {
            userNameElem.classList.add('highlight');
        }
        // 发起 AJAX 请求以获取用户信息
        fetch('/shop/shoppage/shop_order/user/' + userId + '/') // 请注意路径的改变
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(user => {
                // 以下代码是将获取到的用户数据填充到模态框
                document.getElementById('userModel_u_name').textContent = user.u_name;
                document.getElementById('userModel_u_sex').textContent = user.u_sex;
                document.getElementById('userModel_u_phone').textContent = user.u_phone;
                document.getElementById('userModel_u_email').textContent = user.u_email;
                document.getElementById('userModel_u_address').textContent = user.u_address;
                // 显示模态框
                document.getElementById('userModel').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
            });
    }

    function showProductModel(p_id) {
        // 获取商品名字的元素并添加高亮类
        var productNameElem = document.querySelector('td[onclick="showProductModel(' + p_id + ')"]');
        if (productNameElem) {
            productNameElem.classList.add('highlight');
        }
        // 发起 AJAX 请求以获取商品信息
        fetch('/shop/shoppage/shop_order/product/' + p_id + '/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(product => {
                // 以下代码是将获取到的商品数据填充到模态框
                document.getElementById('productModel_p_name').textContent = product.p_name;
                document.getElementById('productModel_p_type').textContent = product.p_type;
                document.getElementById('productModel_brand').textContent = product.brand;
                // 如果您想显示其他信息，那么以下是示例
                // 确保这些元素在商品信息模态框中有对应的 span 标签
                document.getElementById('productModel_current_price').textContent = product.current_price;
                document.getElementById('productModel_product_desc').textContent = product.product_desc;
                document.getElementById('productModel_product_status').textContent = product.product_status;
                document.getElementById('productModel_stock_quantity').textContent = product.stock_quantity;
                document.getElementById('productModel_original_price').textContent = product.original_price;
                document.getElementById('productModel_discount').textContent = product.discount;
                // 设置商品图片
                var productImage = document.getElementById('productModel_product_image');
                var imageUrl = product.product_image_url ? '{% static "商品图片/" %}' + product.product_image_url : '{% static "商品图片/暂无图片.png" %}';
                productImage.src = imageUrl;
                productImage.alt = product.p_name || '商品图片'; // 使用商品名称作为图片的alt文本，如果没有名称则使用'商品图片'

                // 显示模态框
                document.getElementById('productModel').style.display = 'block';
            })

    }

    function shipOrder(orderId) {
        // 发起POST请求到服务器，以执行发货操作
        fetch('/shop/shoppage/shop_order/ship/' + orderId + '/', {
            method: 'POST', // 指定请求方法为POST
            headers: {
                'X-CSRFToken': getCookie('csrftoken'), // 从cookie中获取CSRF token
                'Content-Type': 'application/json' // 设置内容类型为JSON
            },
            body: JSON.stringify({'order_id': orderId}), // 将订单ID作为JSON格式的字符串发送
            credentials: 'same-origin'  // 确保发送请求的时候包含cookies
        })
            .then(response => {
                // 确认响应成功返回
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); // 解析服务器响应的JSON数据
            })
            .then(data => {
                // 这里可以根据返回的数据进行操作，比如更新页面上的订单状态
                if (data.success) {
                    document.getElementById('status-' + orderId).textContent = '待收货';
                    // 隐藏发货按钮，因为已经发货
                    // 定义一个定时器，3秒后刷新页面
                    setTimeout(function () {
                        location.reload(); // 刷新页面
                    }, 2000);
                } else {
                    // 处理服务器返回的错误，比如弹出提醒
                    alert(data.error);
                }
            })
            .catch(error => {
                // 请求出错时的处理
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    // 辅助函数用于获取cookie值
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 函数：当点击表格行时切换订单详情的显示
    function onRowClick(orderId) {
        toggleOrderDetails('details-' + orderId);
    }

    // 当文档加载完毕后，绑定事件到所有的订单行
    document.addEventListener('DOMContentLoaded', function () {
        var orderRows = document.querySelectorAll('.order-row');
        orderRows.forEach(function (row) {
            row.addEventListener('click', function () {
                var orderId = this.getAttribute('data-order-id');
                onRowClick(orderId);
            });
        });
    });
</script>

</body>

</html>