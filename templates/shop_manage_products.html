<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    {% load static %}
    <title>shop_manage_products</title>
    <link rel="stylesheet" href="{% static '商家_files/head.css' %}">
    <link rel="stylesheet" href="{% static '商家_files/shop_manage_products.css' %}">


    <style>
        /* 设置搜索框区域的样式 */
        #search-bar {
            background-color: #f8f9fa; /* 设置搜索栏的背景颜色 */
            padding: 20px; /* 设置内边距使内容不紧贴边框 */
            border-radius: 8px; /* 设置边框为圆角 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 添加层次感的阴影效果 */
            margin-bottom: 20px; /* 与页面其他部分保持距离 */
        }

        /* 格式化搜索行 */
        .search-row {
            justify-content: center; /* 居中对齐 */
            display: flex; /* 使用Flexbox布局 */
            gap: 10px; /* 设置字段之间的间隔距离 */
            margin-bottom: 20px; /* 行与行之间的间隔 */
        }

        /* 设置搜索字段的边框和背景 */
        .search-field {
            display: flex; /* 使用Flexbox布局 */
            flex-direction: row; /* 子元素方向排列 */
            border: 1px solid #ced4da; /* 设置边框颜色和宽度 */
            background-color: #fff; /* 设置背景颜色 */
            border-radius: 4px; /* 字段的边框圆角 */
            padding-left: 10px; /* 字段内部左边距 */
            margin-right: 8px; /* 字段间的距离 */
        }

        /* 美化按钮的样式 */
        input[type="submit"], input[type="reset"] {
            cursor: pointer; /* 鼠标悬停时的手型光标 */
            font-weight: bold; /* 字体加粗 */
            background-color: #007bff; /* 背景颜色 */
            border: none; /* 无边框 */
            border-radius: 4px; /* 圆角边框 */
            color: white; /* 文字颜色 */
            padding: 10px 20px; /* 内边距 */
            margin: 0 5px; /* 外边距进行留白 */
            transition: background-color 0.3s; /* 过渡效果使按钮按下更具反馈 */
        }

        /* 添加鼠标悬停时按钮的效果 */
        input[type="submit"]:hover, input[type="reset"]:hover {
            background-color: #0056b3; /* 按钮被悬停时的背景颜色 */
        }

        /* 清除搜索按钮特定样式 */
        input[type="reset"] {
            background-color: #6c757d; /* 设置清除按钮的背景颜色 */
        }

        input[type="reset"]:hover {
            background-color: #5a6268; /* 按钮被悬停时的背景颜色 */
        }
    </style>
</head>
<body>

<div class="head">
    <div class="head-in">
        <div class="register"><a href="http://127.0.0.1:8000/shop/shoppage/shop_profile">查看个人信息</a></div>
        <div class="register"><a href="{% url 'logout' %}">退出登录</a></div>
    </div>
</div>
<div class="search">
    <form action="{% url 'shop_search_products' %}" method="get" id="search-form" class="input">
        <input type="text" name="query" value="{{ query|default_if_none:'请输入想找的宝贝' }}"
               style="color: {{ query|yesno:'#000,#aaa' }};"
               onfocus="if (this.value == '请输入想找的宝贝') {this.value = ''; this.style.color = '#000';}"
               onblur="if (this.value == '') {this.value = '请输入想找的宝贝'; this.style.color = '#aaa';}">
        <img src="{% static '首页_files/1_06.png' %}" onclick="document.getElementById('search-form').submit();"
             style="cursor: pointer;">
    </form>
</div>
<div class="classes">
    <ul class="classes-items">

        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/myproducts/?category_id=0">我的商品</a></li>
        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=0">管理商品</a></li>
        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/shop_order/">我的订单</a></li>
        <li class="items"><a href="http://127.0.0.1:8000/shop/shoppage/rfm/">RFM分析</a></li>
    </ul>
    <ul class="classes-items">
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=0">全部商品</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=1">个人电脑和配件</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=2">移动设备</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=3">家用电子产品</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=4">厨房电子设备</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=5">办公设备</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=6">汽车电子设备</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=7">网络和通信设备</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=8">可穿戴设备</a></li>
        <li class="items"><a
                href="http://127.0.0.1:8000/shop/shoppage/manage_products/?category_id=9">智能家居设备</a></li>
    </ul>

    <!-- 在这里添加一个 '增加商品' 的按钮 -->
    <div class="add-product-button">
        <a href="{% url 'add_product' %}" class="btn btn-success">增加商品</a>
        <a href="javascript:void(0);" onclick="toggleSearchBar();" class="btn btn-info">搜索商品</a>
    </div>
    <!-- 创建一个初始隐藏的搜索栏 -->
    <!-- 创建一个初始隐藏的搜索栏 -->
    <div id="search-bar" style="display: none;">
        <form action="{% url 'shop_search_manage_products' %}" method="get">
            <!-- 第一行 -->
            <div class="search-row">
                <div class="search-field">
                    <label for="product_name">商品名称:</label>
                    <input type="text" id="product_name" name="product_name" placeholder="商品名称"
                           value="{{ product_name }}">
                </div>
                <div class="search-field">
                    <label for="brand">品牌:</label>
                    <input type="text" id="brand" name="brand" placeholder="品牌" value="{{ brand }}">
                </div>
                <div class="search-field">
                    <label for="stock">库存:</label>
                    <input type="number" id="stock" name="stock" placeholder="库存" value="{{ stock }}">
                </div>
            </div>
            <!-- 第二行 -->
            <div class="search-row">
                <div class="search-field">
                    <label for="category_id">类别:</label>
                    <select id="category_id" name="category_id">
                        <option value="0" {% if category_id == "0" %}selected{% endif %}>全部商品</option>
                        <option value="1" {% if category_id == "1" %}selected{% endif %}>个人电脑和配件</option>
                        <option value="2" {% if category_id == "2" %}selected{% endif %}>移动设备</option>
                        <option value="3" {% if category_id == "3" %}selected{% endif %}>家用电子产品</option>
                        <option value="4" {% if category_id == "4" %}selected{% endif %}>厨房电子设备</option>
                        <option value="5" {% if category_id == "5" %}selected{% endif %}>办公设备</option>
                        <option value="6" {% if category_id == "6" %}selected{% endif %}>汽车电子设备</option>
                        <option value="7" {% if category_id == "7" %}selected{% endif %}>网络和通信设备</option>
                        <option value="8" {% if category_id == "8" %}selected{% endif %}>可穿戴设备</option>
                        <option value="9" {% if category_id == "9" %}selected{% endif %}>智能家居设备</option>
                    </select>
                </div>
                <div class="search-field">
                    <label for="status">状态:</label>
                    <select id="status" name="status">
                        <option value="">所有状态</option>
                        <option value="上架" {% if status == "上架" %}selected{% endif %}>上架</option>
                        <option value="下架" {% if status == "下架" %}selected{% endif %}>下架</option>
                    </select>
                </div>
                <div class="search-field">
                    <label for="audit_status">审核状态:</label>
                    <select id="audit_status" name="audit_status">
                        <option value="">所有状态</option>
                        <option value="待审核" {% if audit_status == "待审核" %}selected{% endif %}>待审核</option>
                        <option value="审核通过" {% if audit_status == "审核通过" %}selected{% endif %}>审核通过
                        </option>
                        <option value="审核不通过" {% if audit_status == "审核不通过" %}selected{% endif %}>审核不通过
                        </option>
                    </select>
                </div>
            </div>
            <!-- 第三行 -->
            <div class="search-row">
                <div class="search-field">
                    <label for="original_price">原始价格:</label>
                    <input type="number" id="original_price" name="original_price" placeholder="原始价格"
                           value="{{ original_price }}">
                </div>
                <div class="search-field">
                    <label for="discount">折扣:</label>
                    <input type="text" id="discount" name="discount" placeholder="折扣" value="{{ discount }}">
                </div>
                <div class="search-field">
                    <label for="current_price">现在价格:</label>
                    <input type="number" id="current_price" name="current_price" placeholder="现在价格"
                           value="{{ current_price }}">
                </div>
            </div>
            <!-- 第四行 -->
            <div class="search-row">
                <div class="search-field">
                    <label for="description">描述:</label>
                    <input type="text" id="description" name="description" placeholder="描述" value="{{ description }}">
                </div>
            </div>
            <!-- 第五行 -->
            <div class="search-row">
                <div class="search-field">
                    <input type="submit" value="搜索">
                    <input type="reset" value="清除搜索" onclick="clearSearch()">
                </div>
            </div>
        </form>
    </div>
    {% if shop_products %}
        <table>
            <tr>
                <th>商品名称</th>
                <th>图片</th>
                <th>类别</th>
                <th>品牌</th>
                <th>描述</th>
                <th>状态</th>
                <th>审核状态</th>
                <th>库存</th>
                <th>原始价格</th>
                <th>折扣</th>
                <th>现在价格</th>
                <th>详情</th>
                <th>修改</th>
                <th>删除</th>
            </tr>
            {% for shop_product in shop_products %}
                <tr>
                    <td>{{ shop_product.product.p_name }}</td>
                    <td><img src="{% static '商品图片/'|add:shop_product.product_image_url %}" alt="商品图片"
                             width="100px"
                             height="100px"></td>
                    <td>{{ shop_product.product.p_type.category_name }}</td>
                    <td>{{ shop_product.product.brand }}</td>
                    <td>{{ shop_product.product_desc }}</td>
                    <td>{{ shop_product.product_status }}</td>
                    <td>{{ shop_product.product_auditstatus }}</td>
                    <td>{{ shop_product.stock_quantity }}</td>
                    <td>{{ shop_product.original_price }}</td>
                    <td>{{ shop_product.discount }}</td>
                    <td>{{ shop_product.current_price }}</td>
                    <td>
                        <!-- 新增的详情按钮 -->
                        <a href="{% url 'shop_productdetails' shop_product.shop_product_id %}"
                           class="btn btn-info">详情</a>
                    </td>
                    <td>
                        <!-- 修改按钮 -->
                        <a href="{% url 'edit_product' shop_product.shop_product_id %}"
                           class="btn btn-primary">修改</a>
                    </td>
                    <td>
                        <!-- 删除按钮 -->
                        <a href="javascript:void(0);" onclick="confirmDelete({{ shop_product.shop_product_id }});"
                           class="btn btn-danger">删除</a>
                    </td>
                </tr>
            {% endfor %}
        </table>
        <!-- 分页 -->
        <div class="pagination">
    <span class="step-links">
    {% if shop_products.has_previous %}
        <a href="?page=1&category_id={{ category_id }}&product_name={{ product_name }}&brand={{ brand }}&description={{ description }}&status={{ status }}&audit_status={{ audit_status }}&stock={{ stock }}&original_price={{ original_price }}&discount={{ discount }}&current_price={{ current_price }}">&laquo; 第一页</a>
        <a href="?page={{ shop_products.previous_page_number }}&category_id={{ category_id }}&product_name={{ product_name }}&brand={{ brand }}&description={{ description }}&status={{ status }}&audit_status={{ audit_status }}&stock={{ stock }}&original_price={{ original_price }}&discount={{ discount }}&current_price={{ current_price }}">上一页</a>
    {% endif %}
        <span class="current">
        第 {{ shop_products.number }} / {{ shop_products.paginator.num_pages }} 页
    </span>
        {% if shop_products.has_next %}
            <a href="?page={{ shop_products.next_page_number }}&category_id={{ category_id }}&product_name={{ product_name }}&brand={{ brand }}&description={{ description }}&status={{ status }}&audit_status={{ audit_status }}&stock={{ stock }}&original_price={{ original_price }}&discount={{ discount }}&current_price={{ current_price }}">下一页</a>
            <a href="?page={{ shop_products.paginator.num_pages }}&category_id={{ category_id }}&product_name={{ product_name }}&brand={{ brand }}&description={{ description }}&status={{ status }}&audit_status={{ audit_status }}&stock={{ stock }}&original_price={{ original_price }}&discount={{ discount }}&current_price={{ current_price }}">最后一页 &raquo;</a>
        {% endif %}
    </span>

            <!-- 页码跳转表单，同时也传递所有搜索参数 -->
            <form action="" method="get" style="display: inline-block;">
                <!-- 保留之前的页面和搜索参数 -->
                <input type="hidden" name="category_id" value="{{ category_id }}">
                <input type="hidden" name="product_name" value="{{ product_name }}">
                <input type="hidden" name="brand" value="{{ brand }}">
                <input type="hidden" name="description" value="{{ description }}">
                <input type="hidden" name="status" value="{{ status }}">
                <input type="hidden" name="audit_status" value="{{ audit_status }}">
                <input type="hidden" name="stock" value="{{ stock }}">
                <input type="hidden" name="original_price" value="{{ original_price }}">
                <input type="hidden" name="discount" value="{{ discount }}">
                <input type="hidden" name="current_price" value="{{ current_price }}">
                <input type="number" name="page" min="1" max="{{ shop_products.paginator.num_pages }}" required
                       placeholder="页码" style="margin-left: 10px;">
                <input type="submit" value="跳转">
            </form>
        </div>
    {% else %}
        <div class="no-products-animation">
            <p>还没有商品哦！</p>
        </div>
    {% endif %}
</div>
<!-- 消息提示 -->
{% if messages %}
    <div id="message-container" class="messages">
        {% for message in messages %}
            <div class="{{ message.tags }} message">{{ message }}</div>
        {% endfor %}
    </div>
{% endif %}
<!-- 模态框 -->
<!-- 添加商品模态框 -->
<div id="addProductModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>添加商品</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ product_form.as_p }}
            {{ shop_product_form.as_p }}
            <div>
                <label for="id_current_price">现在价格:</label>
                <input id="id_current_price" type="text" name="current_price" readonly>
            </div>
            <div>
                <input id="product_audit_status" type="hidden" name="product_audit_status" value="待审核">
            </div>
            <div class="image-preview-container">
                <img id="preview" src="{% static '商品图片/暂无图片.png' %}" alt="上传修改的商品图片" width="200px"
                     height="200px">
                <input id="product_image" type="file" name="product_image" onchange="previewImage(this)">
            </div>
            <button type="submit" class="btn btn-success">添加商品</button>
        </form>
    </div>
</div>
<!-- 模态框 - 删除商品确认 -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <span class="close-delete-modal">&times;</span>
        <p>你确定要删除这个商品吗？此操作不可恢复！</p>
        <div class="modal-actions">
            <button id="confirmDelete">确定</button>
            <button class="cancel-delete-modal">取消</button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelector('.no-products-animation').style.display = 'block';
    });

    // 获取添加商品模态框元素
    var addProductModal = document.getElementById('addProductModal');
    var closeButtonAddProduct = addProductModal.getElementsByClassName("close")[0];

    // 获取删除商品模态框元素
    var deleteConfirmModal = document.getElementById('deleteConfirmModal');
    var closeButtonDeleteModal = deleteConfirmModal.getElementsByClassName("close-delete-modal")[0];
    var cancelDeleteButton = deleteConfirmModal.getElementsByClassName("cancel-delete-modal")[0];

    // 点击添加商品按钮时，显示添加商品模态框
    document.querySelector('.add-product-button a').onclick = function (event) {
        event.preventDefault();
        addProductModal.style.display = "block";
    }

    // 点击关闭按钮关闭添加商品模态框
    closeButtonAddProduct.onclick = function () {
        addProductModal.style.display = "none";
    }

    // 点击删除按钮时，显示删除商品模态框
    function confirmDelete(productId) {
        document.getElementById('confirmDelete').onclick = function () {
            window.location.href = "/shop/shoppage/manage_products/delete_product/" + productId + "/";
        };
        deleteConfirmModal.style.display = "block";
    }

    // 点击关闭按钮关闭删除商品模态框
    closeButtonDeleteModal.onclick = function () {
        deleteConfirmModal.style.display = "none";
    }

    // 点击取消按钮关闭删除商品模态框
    cancelDeleteButton.onclick = function () {
        deleteConfirmModal.style.display = "none";
    }

    // 点击窗口外区域关闭任何打开的模态框
    window.onclick = function (event) {
        if (event.target == addProductModal) {
            addProductModal.style.display = "none";
        } else if (event.target == deleteConfirmModal) {
            deleteConfirmModal.style.display = "none";
        }
    }

    window.onload = function () {
        // 查找消息容器并准备淡出效果
        var messageContainer = document.getElementById('message-container');
        if (messageContainer) {
            // 设置5秒后执行淡出动画
            setTimeout(function () {
                messageContainer.style.opacity = '0'; // 设置透明度为 0 触发消失效果
                setTimeout(function () {
                    messageContainer.style.display = 'none'; // 设置display为none来完全隐藏
                }, 1000); // 额外的时间确保透明度动画完成
            }, 2000); // 你可以调整这里的时间来控制消息显示多久
        }

        // 获取输入框，定义updateCurrentPrice函数，添加事件监听器
        var originalPriceInput = document.getElementById('id_original_price');
        var discountInput = document.getElementById('id_discount');
        var currentPriceInput = document.getElementById('id_current_price');

        function updateCurrentPrice() {
            var originalPrice = parseFloat(originalPriceInput.value);
            var discount = parseFloat(discountInput.value);
            if (!isNaN(originalPrice) && !isNaN(discount)) {
                var currentPrice = originalPrice * (1 - discount);
                currentPriceInput.value = currentPrice.toFixed(2);
            }
        }

        // 初始根据URL参数判断是否应该显示搜索栏
        var searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has('product_name') ||
            searchParams.has('brand') ||
            searchParams.has('description') ||
            searchParams.has('status') ||
            searchParams.has('stock') ||
            searchParams.has('original_price') ||
            searchParams.has('discount') ||
            searchParams.has('current_price')) {
            // 如果有任何搜索参数存在，则显示搜索栏
            document.getElementById('search-bar').style.display = "block";
        } else {
            // 如果没有搜索参数，则隐藏搜索栏
            document.getElementById('search-bar').style.display = "none";
        }

        // 现在手动计算并更新当前价格
        updateCurrentPrice();

        originalPriceInput.addEventListener('input', updateCurrentPrice);
        discountInput.addEventListener('input', updateCurrentPrice);
    };

    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                document.getElementById('preview').src = e.target.result;
            }

            reader.readAsDataURL(input.files[0]);
        }
    }

    // 切换搜索栏的可见性
    function toggleSearchBar() {
        var searchBar = document.getElementById('search-bar');
        if (searchBar.style.display === "none") {
            searchBar.style.display = "block";
        } else {
            searchBar.style.display = "none";
        }
    }

    function clearSearch() {
        // 获取表单内的所有输入元素
        var inputs = document.getElementById('search-bar').querySelectorAll('input[type=text], input[type=number], select');

        // 设置每个字段的值为空字符串，除了类别下拉选择菜单
        inputs.forEach(function (input) {
            if (input.name === "category_id") {
                input.value = "0";
            } else {
                // 其它输入字段设置为空字符串
                input.value = '';
            }
        });

        // 提交表单以返回所有商品
        var searchForm = document.getElementById('search-bar').querySelector('form');
        searchForm.submit();
    }
</script>
</body>
</html>